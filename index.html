<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>業務組織圖工具（由上而下｜Excel 匯入｜橫式 PDF｜直角連線）</title>

  <!-- 繁體中文顯示 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow: 0 10px 25px rgba(17,24,39,.08);
      --radius:16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      color:var(--text);
      background:linear-gradient(180deg, #fafbff, var(--bg));
    }
    header{
      padding:18px 16px 0;
      max-width:1300px;
      margin:0 auto;
    }
    .title{
      display:flex;
      align-items:flex-end;
      gap:12px;
      flex-wrap:wrap;
    }
    h1{ font-size:22px; margin:0; letter-spacing:.5px; }
    .tag{
      display:inline-block;
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--border);
      padding:3px 8px;
      border-radius:999px;
      transform: translateY(-1px);
    }
    .subtitle{
      font-size:13px;
      color:var(--muted);
      margin:6px 0 0;
      line-height:1.6;
    }

    .wrap{
      max-width:1300px;
      margin:14px auto 28px;
      padding:0 16px;
      display:grid;
      grid-template-columns: 440px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
    }

    .panel{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--border);
    }
    .panel .hd .k{
      font-weight:800;
      font-size:14px;
      margin:0;
    }
    .panel .hd .d{
      margin:6px 0 0;
      font-size:12px;
      color:var(--muted);
      line-height:1.55;
    }
    .panel .bd{ padding:14px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .grid .full{ grid-column:1 / -1; }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
    }
    input, textarea{
      width:100%;
      padding:10px 11px;
      border:1px solid var(--border);
      border-radius:12px;
      outline:none;
      font-size:14px;
      background:#fff;
      font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
    }
    input:focus, textarea:focus{
      border-color:#94a3b8;
      box-shadow:0 0 0 4px rgba(148,163,184,.25);
    }
    textarea{
      min-height:120px;
      resize:vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:12px;
    }

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    button{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
    }
    button.primary{
      border-color:#111827;
      background:#111827;
      color:#fff;
    }
    button.danger{
      border-color:#ef4444;
      color:#ef4444;
      background:#fff;
    }
    button:active{ transform: translateY(1px); }

    .row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      padding:10px;
      border:1px solid var(--border);
      border-radius:12px;
      margin-top:10px;
      background:#fff;
    }
    .row .meta{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .row .meta .name{
      font-weight:800;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .row .meta .sub{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .mini{ display:flex; gap:8px; }
    .mini button{ padding:8px 10px; font-size:13px; }

    .hint{
      margin-top:12px;
      color:var(--muted);
      font-size:12px;
      line-height:1.6;
      border-top:1px dashed var(--border);
      padding-top:12px;
    }
    .warn{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #fecaca;
      background:#fff1f2;
      color:#9f1239;
      font-size:13px;
      line-height:1.55;
      display:none;
      white-space:pre-line;
    }
    .ok{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #bbf7d0;
      background:#f0fdf4;
      color:#166534;
      font-size:13px;
      line-height:1.55;
      display:none;
      white-space:pre-line;
    }

    details{
      border-top:1px dashed var(--border);
      margin-top:12px;
      padding-top:12px;
    }
    summary{
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      color:#0f172a;
      list-style:none;
    }
    summary::-webkit-details-marker{ display:none; }
    .small-note{
      font-size:12px;
      color:var(--muted);
      margin:8px 0 0;
      line-height:1.55;
    }
    .filebox{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    input[type="file"]{
      padding:10px;
      background:#fff;
    }
    .pill{
      display:inline-block;
      font-size:12px;
      color:#334155;
      background:#f1f5f9;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid var(--border);
    }

    /* 右側圖區（可捲動） */
    .canvas{
      position:relative;
      height: calc(100vh - 140px);
      min-height:600px;
      background: radial-gradient(1200px 600px at 20% 0%, #ffffff 0%, #f6f7fb 60%);
      border-radius:var(--radius);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      overflow:auto;
    }
    @media (max-width: 980px){ .canvas{ height: 70vh; } }

    /* PDF：只截「單頁組織圖」用 */
    .pdf-area{
      position:relative;
      display:inline-block;
      background:#fff;
      border:1px solid var(--border);
      border-radius:16px;
      padding:18px 18px 22px;
      margin:18px;
      box-shadow: 0 8px 18px rgba(17,24,39,.06);
    }
    .pdf-title{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      padding:0 0 12px;
      border-bottom:1px dashed var(--border);
      margin-bottom:14px;
    }
    .pdf-title .left .t1{
      font-weight:900; font-size:16px; margin:0;
    }
    .pdf-title .left .t2{
      margin:6px 0 0;
      font-size:12px;
      color:var(--muted);
      line-height:1.55;
    }
    .pdf-title .right{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    /* 樹狀版面：座標定位 */
    .stage{
      position:relative;
      min-width: 980px;
      min-height: 520px;
      padding:0;
    }
    svg.lines{
      position:absolute;
      top:0; left:0;
      width:100%;
      height:100%;
      pointer-events:none;
    }
    .nodes{
      position:absolute;
      top:0; left:0;
      width:100%;
      height:100%;
    }
    .node{
      width:220px;
      background:rgba(255,255,255,.95);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px 12px 12px;
      box-shadow: 0 8px 18px rgba(17,24,39,.06);
      text-align:center;
      position:absolute;
      transform: translate(-50%, 0);
    }
    .node .nm{
      font-weight:900;
      font-size:15px;
      margin:0;
    }
    .node .tt{
      font-size:12px;
      color:var(--muted);
      margin:8px 0 0;
    }
  </style>

  <!-- Excel 解析：SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- 截圖：html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <!-- ✅ jsPDF：主程式內動態備援載入 -->
</head>

<body>
  <header>
    <div class="title">
      <h1>業務組織圖工具（由上而下）</h1>
      <span class="tag">單檔 HTML｜Excel 匯入｜橫式 PDF 單頁下載｜直角連線</span>
    </div>
    <p class="subtitle">
      手動輸入「姓名、職稱、上一代主管姓名」建立組織，也可上傳 Excel（欄位：上一代主管、姓名、職級）自動匯入並生成組織圖。
    </p>
  </header>

  <main class="wrap">
    <!-- 左：控制面板 -->
    <section class="panel">
      <div class="hd">
        <p class="k">輸入 / 匯入資料</p>
        <p class="d">「上一代主管姓名」留空＝最上層。為避免判斷錯誤，建議姓名不要重複。</p>
      </div>
      <div class="bd">
        <div class="grid">
          <div>
            <label>姓名</label>
            <input id="inpName" placeholder="例如：王小明" />
          </div>
          <div>
            <label>職稱 / 職級</label>
            <input id="inpTitle" placeholder="例如：業務襄理" />
          </div>
          <div class="full">
            <label>上一代主管姓名（留空＝最上層）</label>
            <input id="inpManager" placeholder="例如：陳經理" />
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="btnAdd">新增人員</button>
          <button id="btnRender">更新組織圖</button>
          <button class="primary" id="btnPdf">下載單頁組織圖 PDF（橫式）</button>
          <button class="danger" id="btnReset">清空全部</button>
        </div>

        <div id="msgWarn" class="warn"></div>
        <div id="msgOk" class="ok"></div>

        <details open>
          <summary>Excel 上傳匯入（欄位：上一代主管、姓名、職級）</summary>
          <p class="small-note">
            Excel 第一列請放欄位名稱，必須包含：<b>上一代主管</b>、<b>姓名</b>、<b>職級</b>（欄名需完全相同）。<br/>
            若「上一代主管」為空白，視為最上層。
          </p>
          <div class="filebox">
            <input id="fileExcel" type="file" accept=".xlsx,.xls" />
            <span class="pill" id="excelStatus">尚未選擇檔案</span>
          </div>
          <div class="btns">
            <button id="btnImportExcel">匯入並產生組織圖</button>
          </div>
        </details>

        <details>
          <summary>進階：批次匯入 / 匯出（貼上資料陣列 JSON）</summary>
          <p class="small-note">格式：<code>[{"name":"姓名","title":"職級","manager":"上一代主管姓名"}...]</code></p>
          <label style="margin-top:10px;">資料陣列（JSON）</label>
          <textarea id="jsonArea"></textarea>
          <div class="btns">
            <button id="btnApplyJson">套用</button>
            <button id="btnCopyJson">複製目前資料</button>
            <button id="btnLoadDemo">載入示範資料</button>
          </div>
        </details>

        <div id="peopleList"></div>

        <p class="hint">
          常見問題排除：<br/>
          1) 若出現「上一代主管不存在」，代表某人的上一代主管姓名在資料中找不到。<br/>
          2) 若出現「迴圈關係」，代表上一代主管追溯回到自己或形成循環。<br/>
          3) PDF 下載會只截右側「單頁組織圖區」並輸出為 A4 橫式單頁。
        </p>
      </div>
    </section>

    <!-- 右：圖區 -->
    <section class="canvas" aria-label="組織圖區域">
      <div class="pdf-area" id="pdfArea">
        <div class="pdf-title">
          <div class="left">
            <p class="t1">組織圖</p>
            <p class="t2">由上而下（適用：組織說明 / 培育 / 晉升展示）</p>
          </div>
          <div class="right" id="pdfStamp"></div>
        </div>

        <div class="stage" id="stage">
          <svg class="lines" id="svgLines"></svg>
          <div class="nodes" id="nodes"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    /**************************************************
     * ✅ jsPDF 備援載入器（解決 CDN 被擋 / 載入失敗）
     **************************************************/
    function loadScript(src){
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.onload = resolve;
        s.onerror = () => reject(new Error("載入失敗：" + src));
        document.head.appendChild(s);
      });
    }

    async function ensureJsPDF(){
      if (window.jspdf && window.jspdf.jsPDF) return true;

      const candidates = [
        "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js",
        "https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js",
        "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"
      ];

      for (const url of candidates){
        try{
          await loadScript(url);
          if (window.jspdf && window.jspdf.jsPDF) return true;
        }catch(e){
          // try next
        }
      }
      return false;
    }

    /**************************************************
     * people = [{ name: "姓名", title: "職級", manager: "上一代主管姓名(可空)" }]
     **************************************************/
    let people = [];

    // DOM
    const inpName = document.getElementById("inpName");
    const inpTitle = document.getElementById("inpTitle");
    const inpManager = document.getElementById("inpManager");

    const btnAdd = document.getElementById("btnAdd");
    const btnRender = document.getElementById("btnRender");
    const btnReset = document.getElementById("btnReset");
    const btnPdf = document.getElementById("btnPdf");

    const peopleList = document.getElementById("peopleList");
    const nodesEl = document.getElementById("nodes");
    const svgLines = document.getElementById("svgLines");

    const msgWarn = document.getElementById("msgWarn");
    const msgOk = document.getElementById("msgOk");

    const jsonArea = document.getElementById("jsonArea");
    const btnApplyJson = document.getElementById("btnApplyJson");
    const btnCopyJson = document.getElementById("btnCopyJson");
    const btnLoadDemo = document.getElementById("btnLoadDemo");

    const fileExcel = document.getElementById("fileExcel");
    const excelStatus = document.getElementById("excelStatus");
    const btnImportExcel = document.getElementById("btnImportExcel");

    const pdfArea = document.getElementById("pdfArea");
    const pdfStamp = document.getElementById("pdfStamp");
    const stage = document.getElementById("stage");

    // helpers
    function showWarn(text){
      msgWarn.style.display = "block";
      msgWarn.textContent = text || "";
      msgOk.style.display = "none";
      msgOk.textContent = "";
    }
    function showOk(text){
      msgOk.style.display = "block";
      msgOk.textContent = text || "";
      msgWarn.style.display = "none";
      msgWarn.textContent = "";
    }
    function clearMsg(){
      msgWarn.style.display = "none";
      msgWarn.textContent = "";
      msgOk.style.display = "none";
      msgOk.textContent = "";
    }
    function pad2(n){ return String(n).padStart(2,"0"); }
    function nowStamp(){
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }
    function normalize(s){ return (s ?? "").toString().trim(); }
    function escapeHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function hasDuplicateNames(arr){
      const set = new Set();
      for(const p of arr){
        const n = normalize(p.name);
        if(!n) continue;
        if(set.has(n)) return true;
        set.add(n);
      }
      return false;
    }

    // ===== tree build + validate =====
    function buildTree(data){
      const map = new Map();
      const errors = [];

      for(const p of data){
        const name = normalize(p.name);
        if(!name){ errors.push("有資料列的「姓名」是空白。"); continue; }
        map.set(name, { ...p, name, title: normalize(p.title), manager: normalize(p.manager), children: [] });
      }

      const roots = [];
      for(const node of map.values()){
        if(node.manager){
          const parent = map.get(node.manager);
          if(!parent){
            errors.push(`「${node.name}」的上一代主管「${node.manager}」不存在於資料中。`);
          }else{
            parent.children.push(node);
          }
        }else{
          roots.push(node);
        }
      }

      // cycle detect
      const visiting = new Set();
      const visited = new Set();
      function dfsCycle(n){
        if(visiting.has(n.name)) return true;
        if(visited.has(n.name)) return false;
        visiting.add(n.name);
        const parentName = n.manager;
        if(parentName && map.has(parentName)){
          if(dfsCycle(map.get(parentName))) return true;
        }
        visiting.delete(n.name);
        visited.add(n.name);
        return false;
      }
      for(const n of map.values()){
        if(dfsCycle(n)){
          errors.push("資料中存在「迴圈關係」（上一代主管追溯回到自己或形成循環）。");
          break;
        }
      }

      if(roots.length === 0 && map.size > 0){
        errors.push("找不到最上層（所有人都有上一代主管，或上一代主管不存在）。");
      }

      for(const node of map.values()){
        node.children.sort((a,b) => a.name.localeCompare(b.name, "zh-Hant"));
      }
      roots.sort((a,b) => a.name.localeCompare(b.name, "zh-Hant"));

      return { roots, errors };
    }

    // ===== tidy tree layout (Buchheim) =====
    function computeLayout(roots){
      const NODE_W = 220;
      const NODE_H = 74;
      const H_GAP  = 60;
      const V_GAP  = 110;
      const PADDING = 30;

      function wrap(node, parent=null, depth=0, number=1){
        const w = {
          node, parent,
          children: [],
          depth, number,
          x:0, y:0,
          prelim:0, mod:0,
          change:0, shift:0,
          ancestor:null, thread:null
        };
        w.ancestor = w;
        if(node.children && node.children.length){
          node.children.forEach((c,i) => w.children.push(wrap(c, w, depth+1, i+1)));
        }
        return w;
      }

      function leftSibling(v){
        if(!v.parent) return null;
        const i = v.number - 2;
        return i >= 0 ? v.parent.children[i] : null;
      }
      function leftMostSibling(v){
        if(!v.parent) return null;
        return v.parent.children[0] === v ? null : v.parent.children[0];
      }
      function nextLeft(v){
        return v.children.length ? v.children[0] : v.thread;
      }
      function nextRight(v){
        return v.children.length ? v.children[v.children.length-1] : v.thread;
      }

      function moveSubtree(wl, wr, shift){
        const subtrees = wr.number - wl.number;
        wr.change -= shift / subtrees;
        wr.shift += shift;
        wl.change += shift / subtrees;
        wr.prelim += shift;
        wr.mod += shift;
      }

      function executeShifts(v){
        let shift = 0;
        let change = 0;
        for(let i=v.children.length-1;i>=0;i--){
          const w = v.children[i];
          w.prelim += shift;
          w.mod += shift;
          change += w.change;
          shift += w.shift + change;
        }
      }

      function ancestor(vil, v, defaultAncestor){
        if(vil.ancestor.parent === v.parent) return vil.ancestor;
        return defaultAncestor;
      }

      function apportion(v, defaultAncestor, distance){
        const w = leftSibling(v);
        if(!w) return defaultAncestor;

        let vir = v;
        let vor = v;
        let vil = w;
        let vol = leftMostSibling(v);

        let sir = vir.mod;
        let sor = vor.mod;
        let sil = vil.mod;
        let sol = vol.mod;

        while(nextRight(vil) && nextLeft(vir)){
          vil = nextRight(vil);
          vir = nextLeft(vir);
          vol = nextLeft(vol);
          vor = nextRight(vor);

          vor.ancestor = v;

          const shift = (vil.prelim + sil) - (vir.prelim + sir) + distance;
          if(shift > 0){
            const a = ancestor(vil, v, defaultAncestor);
            moveSubtree(a, v, shift);
            sir += shift;
            sor += shift;
          }

          sil += vil.mod;
          sir += vir.mod;
          sol += vol.mod;
          sor += vor.mod;
        }

        if(nextRight(vil) && !nextRight(vor)){
          vor.thread = nextRight(vil);
          vor.mod += sil - sor;
        }
        if(nextLeft(vir) && !nextLeft(vol)){
          vol.thread = nextLeft(vir);
          vol.mod += sir - sol;
          defaultAncestor = v;
        }

        return defaultAncestor;
      }

      function firstWalk(v, distance){
        if(v.children.length === 0){
          const ls = leftSibling(v);
          v.prelim = ls ? ls.prelim + distance : 0;
        }else{
          let defaultAncestor = v.children[0];
          for(const w of v.children){
            firstWalk(w, distance);
            defaultAncestor = apportion(w, defaultAncestor, distance);
          }
          executeShifts(v);
          const midpoint = (v.children[0].prelim + v.children[v.children.length-1].prelim) / 2;
          const ls = leftSibling(v);
          if(ls){
            v.prelim = ls.prelim + distance;
            v.mod = v.prelim - midpoint;
          }else{
            v.prelim = midpoint;
          }
        }
        return v;
      }

      function secondWalk(v, m=0){
        v.x = v.prelim + m;
        v.y = v.depth;
        for(const w of v.children){
          secondWalk(w, m + v.mod);
        }
      }

      const fakeRoot = { name:"__ROOT__", title:"", manager:"", children: roots };
      const wrapped = wrap(fakeRoot);

      const distance = 1;
      firstWalk(wrapped, distance);
      secondWalk(wrapped, 0);

      const positions = new Map();
      let minX = Infinity, maxX = -Infinity, maxDepth = 0;

      function collect(v){
        if(v.node.name !== "__ROOT__"){
          minX = Math.min(minX, v.x);
          maxX = Math.max(maxX, v.x);
          maxDepth = Math.max(maxDepth, v.y);
        }
        for(const c of v.children) collect(c);
      }
      collect(wrapped);

      const UNIT_W = 220 + 60; // NODE_W + H_GAP
      const UNIT_H = 110;      // V_GAP
      const NODE_W = 220;
      const NODE_H = 74;
      const PADDING = 30;

      function fill(v){
        if(v.node.name !== "__ROOT__"){
          const px = PADDING + (v.x - minX) * UNIT_W + NODE_W/2;
          const py = PADDING + (v.y) * UNIT_H;
          positions.set(v.node.name, { x:px, y:py, node:v.node });
        }
        for(const c of v.children) fill(c);
      }
      fill(wrapped);

      const stageW = Math.max(980, PADDING*2 + (maxX - minX) * UNIT_W + NODE_W);
      const stageH = Math.max(520, PADDING*2 + (maxDepth) * UNIT_H + NODE_H + 60);

      return { positions, stageW, stageH, NODE_W, NODE_H };
    }

    // ===== list UI =====
    function renderList(){
      peopleList.innerHTML = "";
      if(people.length === 0){
        const empty = document.createElement("div");
        empty.className = "pill";
        empty.textContent = "目前沒有資料（可手動新增或 Excel 匯入）";
        peopleList.appendChild(empty);
        return;
      }

      for(let i=0;i<people.length;i++){
        const p = people[i];
        const row = document.createElement("div");
        row.className = "row";

        const meta = document.createElement("div");
        meta.className = "meta";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = p.name;

        const sub = document.createElement("div");
        sub.className = "sub";
        sub.textContent = `職級：${p.title || "（未填）"} ｜ 上一代主管：${p.manager || "（最上層）"}`;

        meta.appendChild(name);
        meta.appendChild(sub);

        const mini = document.createElement("div");
        mini.className = "mini";

        const btnEdit = document.createElement("button");
        btnEdit.textContent = "編輯";
        btnEdit.onclick = () => {
          inpName.value = p.name;
          inpTitle.value = p.title || "";
          inpManager.value = p.manager || "";
          showOk("已帶入欄位，修改後按「新增人員」會以同名覆蓋更新。");
        };

        const btnDel = document.createElement("button");
        btnDel.textContent = "刪除";
        btnDel.onclick = () => {
          people.splice(i,1);
          clearMsg();
          renderAll();
        };

        mini.appendChild(btnEdit);
        mini.appendChild(btnDel);

        row.appendChild(meta);
        row.appendChild(mini);
        peopleList.appendChild(row);
      }
    }

    // ===== chart render =====
    function clearChart(){
      nodesEl.innerHTML = "";
      svgLines.innerHTML = "";
    }

    function renderChart(){
      clearChart();
      pdfStamp.textContent = `匯出時間：${nowStamp()}`;

      if(people.length === 0){
        stage.style.width = "980px";
        stage.style.height = "520px";
        const el = document.createElement("div");
        el.className = "node";
        el.style.left = "50%";
        el.style.top = "30px";
        el.innerHTML = `<p class="nm">尚未輸入資料</p><p class="tt">請在左側新增人員或匯入 Excel</p>`;
        nodesEl.appendChild(el);
        return;
      }

      if(hasDuplicateNames(people)){
        showWarn("偵測到「姓名重複」。建議避免重複姓名，否則上一代主管比對可能錯誤。\n你仍可繼續產生，但結果可能不準。");
      }

      const { roots, errors } = buildTree(people);
      if(errors.length){
        showWarn(errors.join("\n"));
      }else{
        clearMsg();
      }

      const layout = computeLayout(roots);
      stage.style.width = layout.stageW + "px";
      stage.style.height = layout.stageH + "px";

      for(const [name, p] of layout.positions){
        const n = p.node;
        const el = document.createElement("div");
        el.className = "node";
        el.dataset.name = n.name;
        el.style.left = p.x + "px";
        el.style.top  = p.y + "px";
        el.innerHTML = `
          <p class="nm">${escapeHtml(n.name)}</p>
          <p class="tt">${escapeHtml(n.title || "（未填職級）")}</p>
        `;
        nodesEl.appendChild(el);
      }

      drawLinesAbsolute(layout);
    }

    // ✅直角連線（折點靠「中間一點」，但留一點上下緩衝更好看）
    function drawLinesAbsolute(layout){
      svgLines.innerHTML = "";
      svgLines.setAttribute("width", layout.stageW);
      svgLines.setAttribute("height", layout.stageH);
      svgLines.setAttribute("viewBox", `0 0 ${layout.stageW} ${layout.stageH}`);

      const NODE_H = layout.NODE_H;

      for(const p of people){
        const childName = normalize(p.name);
        const parentName = normalize(p.manager);
        if(!parentName) continue;

        const childPos = layout.positions.get(childName);
        const parentPos = layout.positions.get(parentName);
        if(!childPos || !parentPos) continue;

        const ax = parentPos.x;
        const ay = parentPos.y + NODE_H;
        const bx = childPos.x;
        const by = childPos.y;

        const gap = Math.max(0, by - ay);

        // 折點：偏中間（55%），並且至少離父節點底部 18px、離子節點頂部 18px
        let midY = ay + gap * 0.55;
        midY = Math.max(midY, ay + 18);
        midY = Math.min(midY, by - 18);

        midY = Math.round(midY);

        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("d", `M ${ax} ${ay} V ${midY} H ${bx} V ${by}`);
        path.setAttribute("fill", "none");
        path.setAttribute("stroke", "#cbd5e1");
        path.setAttribute("stroke-width", "2");
        path.setAttribute("stroke-linecap", "round");
        path.setAttribute("stroke-linejoin", "round");
        svgLines.appendChild(path);
      }
    }

    // ===== actions =====
    btnAdd.addEventListener("click", () => {
      clearMsg();
      const name = normalize(inpName.value);
      const title = normalize(inpTitle.value);
      const manager = normalize(inpManager.value);

      if(!name){
        showWarn("請先輸入「姓名」。");
        return;
      }

      const idx = people.findIndex(x => normalize(x.name) === name);
      const item = { name, title, manager };
      if(idx >= 0){
        people[idx] = item;
        showOk(`已更新：${name}`);
      }else{
        people.push(item);
        showOk(`已新增：${name}`);
      }

      inpName.value = "";
      inpTitle.value = "";
      inpManager.value = "";
      renderAll();
    });

    btnRender.addEventListener("click", () => {
      clearMsg();
      renderAll();
    });

    btnReset.addEventListener("click", () => {
      people = [];
      clearMsg();
      renderAll();
      showOk("已清空全部資料。");
    });

    // JSON import/export
    btnCopyJson.addEventListener("click", async () => {
      try{
        const text = JSON.stringify(people, null, 2);
        jsonArea.value = text;
        await navigator.clipboard.writeText(text);
        showOk("已複製目前資料（JSON）到剪貼簿，並同步填入文本框。");
      }catch(e){
        jsonArea.value = JSON.stringify(people, null, 2);
        showOk("已填入 JSON（你的瀏覽器可能不允許自動複製，請手動全選複製）。");
      }
    });

    btnApplyJson.addEventListener("click", () => {
      clearMsg();
      try{
        const arr = JSON.parse(jsonArea.value || "[]");
        if(!Array.isArray(arr)) throw new Error("JSON 必須是一個陣列。");
        people = arr.map(x => ({
          name: normalize(x.name),
          title: normalize(x.title),
          manager: normalize(x.manager),
        })).filter(x => x.name);

        showOk(`已套用 JSON 匯入，共 ${people.length} 筆。`);
        renderAll();
      }catch(err){
        showWarn("JSON 解析失敗：\n" + (err?.message || String(err)));
      }
    });

    btnLoadDemo.addEventListener("click", () => {
      clearMsg();
      people = [
        { name:"陳大三", title:"業務主任", manager:"" },
        { name:"王大二", title:"專案SR", manager:"陳大三" },
        { name:"王大一", title:"業務主任", manager:"陳大三" },
        { name:"王小七", title:"業務代表", manager:"王大二" },
        { name:"林小美", title:"業務代表", manager:"王大一" }
      ];
      showOk("已載入示範資料。");
      renderAll();
    });

    // Excel import
    fileExcel.addEventListener("change", () => {
      const f = fileExcel.files?.[0];
      excelStatus.textContent = f ? `已選擇：${f.name}` : "尚未選擇檔案";
      clearMsg();
    });

    btnImportExcel.addEventListener("click", async () => {
      clearMsg();
      const f = fileExcel.files?.[0];
      if(!f){
        showWarn("請先選擇 Excel 檔案（.xlsx 或 .xls）。");
        return;
      }

      try{
        const buf = await f.arrayBuffer();
        const wb = XLSX.read(buf, { type:"array" });
        const sheetName = wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(ws, { defval:"" });

        const needCols = ["上一代主管","姓名","職級"];
        const missing = needCols.filter(c => !(c in (rows[0] || {})));
        if(missing.length){
          showWarn(
            "Excel 欄位不符合，缺少：\n" + missing.join("、") +
            "\n\n請確認第一列欄名必須是：上一代主管、姓名、職級（完全相同）。"
          );
          return;
        }

        const imported = rows
          .map(r => ({
            manager: normalize(r["上一代主管"]),
            name: normalize(r["姓名"]),
            title: normalize(r["職級"]),
          }))
          .filter(x => x.name);

        if(imported.length === 0){
          showWarn("Excel 解析後沒有有效資料（可能姓名欄皆空白）。");
          return;
        }

        people = imported.map(x => ({ name:x.name, title:x.title, manager:x.manager }));
        showOk(`Excel 匯入完成：共 ${people.length} 筆（工作表：${sheetName}）。`);
        renderAll();
      }catch(err){
        showWarn("Excel 解析失敗：\n" + (err?.message || String(err)));
      }
    });

    // ✅ PDF export（先確保 jsPDF 載入）
    btnPdf.addEventListener("click", async () => {
      clearMsg();

      const ok = await ensureJsPDF();
      if(!ok){
        showWarn(
          "PDF 產生失敗：jsPDF 套件仍無法載入。\n" +
          "可能原因：公司網路擋 CDN / 目前離線 / 瀏覽器政策限制。\n\n" +
          "建議解法：\n" +
          "1) 改用 VS Code 的 Live Server（http://）開啟，不要用 file:///。\n" +
          "2) 或換一個網路環境再試。"
        );
        return;
      }

      if (people.length === 0) {
        showWarn("目前沒有資料，無法下載 PDF。");
        return;
      }

      try {
        showOk("正在產生橫式 PDF…");
        await new Promise(r => setTimeout(r, 200));

        const canvas = await html2canvas(pdfArea, {
          backgroundColor: "#ffffff",
          scale: 2,
          useCORS: true
        });

        const imgData = canvas.toDataURL("image/png");
        const { jsPDF } = window.jspdf;

        const pdf = new jsPDF({ orientation: "l", unit: "mm", format: "a4" });

        const pageW = 297, pageH = 210;
        const margin = 8;
        const maxW = pageW - margin * 2;
        const maxH = pageH - margin * 2;

        const imgW = canvas.width, imgH = canvas.height;
        const scale = Math.min(maxW / imgW, maxH / imgH);

        const drawW = imgW * scale;
        const drawH = imgH * scale;

        const x = (pageW - drawW) / 2;
        const y = (pageH - drawH) / 2;

        pdf.addImage(imgData, "PNG", x, y, drawW, drawH);
        pdf.save(`組織圖_橫式_${nowStamp().replace(/[: ]/g, "-")}.pdf`);

        showOk("橫式 PDF 已下載完成。");
      } catch (err) {
        showWarn("PDF 產生失敗：\n" + (err?.message || String(err)));
      }
    });

    function renderAll(){
      renderList();
      renderChart();
      jsonArea.value = JSON.stringify(people, null, 2);
    }

    // 初始示範資料
    people = [
      { name:"陳大三", title:"業務主任", manager:"" },
      { name:"王大二", title:"專案SR", manager:"陳大三" },
      { name:"王大一", title:"業務主任", manager:"陳大三" },
      { name:"王小七", title:"業務代表", manager:"王大二" },
      { name:"林小美", title:"業務代表", manager:"王大一" }
    ];
    renderAll();
  </script>
</body>
</html>
